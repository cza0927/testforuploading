<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Submission</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        .form-container {
            max-width: 400px;
            margin: 0 auto;
        }
        label, input, textarea {
            width: 100%;
            margin-bottom: 10px;
        }
        button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Submit Data to GitHub</h1>
    <div class="form-container">
        <form id="submissionForm">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>

            <label for="data">Data:</label>
            <textarea id="data" name="data" rows="4" required></textarea>

            <button type="submit">Submit</button>
        </form>
    </div>

    <script>
        const form = document.getElementById('submissionForm');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const data = document.getElementById('data').value;

            const submission = {
                username: username,
                data: data,
                timestamp: new Date().toISOString()
            };

            // Define GitHub repository and file path
            const repoOwner = 'cza0927';
            const repoName = 'testforuploading';
            const filePath = 'submission.json';

            // Set up GitHub API URL
            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            const token = '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'; // Replace with your GitHub token

            let fileContent = '';
            let sha = '';

            // Fetch the current content of submission.json if it exists
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    fileContent = atob(data.content); // Decode base64 content
                    sha = data.sha;
                } else {
                    // If the file does not exist, initialize fileContent as an empty array
                    if (response.status === 404) {
                        console.log('File does not exist. A new file will be created.');
                    } else {
                        throw new Error(`Failed to fetch file content: ${response.statusText}`);
                    }
                }
            } catch (error) {
                console.error('Error fetching file content:', error);
                alert('An error occurred while fetching the file content.');
                return; // Stop further execution if fetching fails
            }

            // Add new submission to the existing content
            const submissions = fileContent ? JSON.parse(fileContent) : [];
            submissions.push(submission);

            // Prepare the content to be committed to GitHub
            const updatedContent = JSON.stringify(submissions, null, 2);
            const encodedContent = btoa(updatedContent); // Base64 encode the content

            // Commit the update to GitHub
            const commitMessage = 'Add new submission';
            const updateData = {
                message: commitMessage,
                content: encodedContent,
                sha: sha || '' // If sha is empty (first time), pass an empty string
            };

            try {
                const updateResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (updateResponse.ok) {
                    alert('Submission successful!');
                } else {
                    const responseData = await updateResponse.json();
                    alert(`Failed to update submission. Response: ${responseData.message}`);
                }
            } catch (error) {
                console.error('Error updating file:', error);
                alert('An error occurred while submitting data.');
            }
        });
    </script>
</body>
</html>
